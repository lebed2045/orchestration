# /o3 - Anti-Regression Orchestrator v3

**Version 3**: Regression-proof workflow. Born from documented Claude failures.

**Core principle**: NEVER claim "done" without EXECUTION PROOF.

Uses agents: `coder-v1`, `planner-v1`, `intake-v1`, `fresh-reviewer-v1`

---

## VSCODE COMPATIBILITY (CRITICAL)

**VSCode plugin has a bug with parallel tool calls. To avoid "API Error: 400":**

1. **DO NOT use Task tool with Explore agent** - It makes parallel calls that crash
2. **Explore manually** - Use Read, Grep, Glob directly, ONE AT A TIME
3. **Sequential tool calls only** - Never batch multiple tool calls in one response
4. **Wait for each result** - Before making next tool call

---

## THE FIVE SINS (from real failures)

These are BLOCKING mistakes that v3 prevents:

| Sin | Description | Prevention |
|-----|-------------|------------|
| **SIN 1** | Claiming "done" without testing | EXECUTION_BLOCK required |
| **SIN 2** | No actual play-testing (only unit tests) | SMOKE_TEST required |
| **SIN 3** | Self-fulfilling tests | BASELINE comparison required |
| **SIN 4** | Fix-break cycle | REGRESSION_DELTA required |
| **SIN 5** | Ignoring warnings | WARNING_COUNT required |

---

## MANDATORY PROOF BLOCKS

### EXECUTION_BLOCK (required for ANY completion claim)

```text
┌─────────────────────────────────────────────┐
│ EXECUTION_BLOCK                             │
├─────────────────────────────────────────────┤
│ $ [actual command run]                      │
│ [actual output - last 20+ lines]            │
│ EXIT_CODE: [0 or N]                         │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

### BASELINE_BLOCK (captured BEFORE any changes)

```text
┌─────────────────────────────────────────────┐
│ BASELINE_BLOCK                              │
├─────────────────────────────────────────────┤
│ Tests passing: [N]                          │
│ Tests failing: [N]                          │
│ Warnings: [N]                               │
│ Errors: [N]                                 │
│ Git SHA: [hash]                             │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

### REGRESSION_DELTA (captured AFTER changes)

```text
┌─────────────────────────────────────────────┐
│ REGRESSION_DELTA                            │
├─────────────────────────────────────────────┤
│ Tests: [N] passed (was [M]) [+/-diff]       │
│ Warnings: [N] (was [M]) [+/-diff]           │
│ Errors: [N] (was [M]) [+/-diff]             │
│ VERDICT: [SAFE|REGRESSION]                  │
└─────────────────────────────────────────────┘
```

**If REGRESSION detected, STOP and report before continuing.**

---

## SMOKE_TEST Requirement

Unit tests are INSUFFICIENT. Before claiming completion:

1. **Check log file**: `smoke-errors.log` or equivalent
2. **Count warnings**: Must not increase
3. **Platform-specific**:
   - Unity: Check Editor console logs
   - Web: Check browser console
   - CLI: Check stderr output

```text
┌─────────────────────────────────────────────┐
│ SMOKE_TEST                                  │
├─────────────────────────────────────────────┤
│ Method: [Editor logs | Manual test | etc]   │
│ Warnings before: [N]                        │
│ Warnings after: [N]                         │
│ New errors: [list or "none"]                │
│ VERDICT: [PASS|FAIL]                        │
└─────────────────────────────────────────────┘
```

---

## FORBIDDEN PHRASES

NEVER output these without preceding PROOF BLOCKS:

- "Done" / "Fixed" / "Complete" / "Finished"
- "Tests pass" / "Should work" / "This fixes it"
- "I verified" / "I tested" / "I confirmed"
- "The issue is resolved"

**Replace with**: "Running verification now..." [then show actual output]

---

## Phase Flow (6 Phases)

### Phase 1: BASELINE_CAPTURE

**Before touching ANY code:**

1. Run existing tests, capture output
2. Count current warnings/errors
3. Record git SHA
4. Output BASELINE_BLOCK

```bash
# Example for npm project
npm test 2>&1 | tee /tmp/baseline.txt
grep -c "warning\|Warning" /tmp/baseline.txt || echo "0"
git rev-parse HEAD
```

**Do NOT proceed without BASELINE_BLOCK.**

### Phase 2: INTAKE

1. Call `EnterPlanMode` tool
2. Ask clarifying questions using `AskUserQuestion`
3. Cover: issue, expected behavior, reproduction steps
4. Write spec to `.claude/temp/spec.md`

### Phase 3: TDD_RED

1. Write test that FAILS (reproduces the bug)
2. Run test, show EXECUTION_BLOCK with failure
3. **If test passes, the test is WRONG** - rewrite it

```text
CRITICAL: A test that passes before the fix is WORTHLESS.
It proves nothing. Rewrite until it FAILS.
```

### Phase 4: TDD_GREEN

1. Implement minimal fix
2. Run tests, show EXECUTION_BLOCK
3. **After EVERY change**, run REGRESSION_DELTA:
   - Compare to BASELINE
   - If warnings increased: STOP
   - If other tests broke: STOP

### Phase 5: SMOKE_VERIFY

1. Run platform-specific smoke test
2. Check log files for new warnings/errors
3. Output SMOKE_TEST block
4. **If FAIL**, iterate on fix

### Phase 6: COMPLETION

Only output completion if ALL conditions met:

- [ ] EXECUTION_BLOCK shows EXIT_CODE=0
- [ ] REGRESSION_DELTA shows no new failures
- [ ] REGRESSION_DELTA shows warnings not increased
- [ ] SMOKE_TEST shows PASS

```text
┌─────────────────────────────────────────────┐
│ COMPLETION CHECKLIST                        │
├─────────────────────────────────────────────┤
│ [x] Tests pass (EXECUTION_BLOCK shown)      │
│ [x] No regression (REGRESSION_DELTA shown)  │
│ [x] Warnings stable (before/after same)     │
│ [x] Smoke test pass (SMOKE_TEST shown)      │
│ VERDICT: COMPLETE                           │
└─────────────────────────────────────────────┘
```

---

## Circuit Breakers

| Trigger | Action |
|---------|--------|
| Claim without EXECUTION_BLOCK | RETRACT. Run verification. |
| Warnings increased | STOP. Fix warnings first. |
| New test failures | STOP. Fix regression first. |
| Same error 2x | STOP. Escalate to user. |
| SMOKE_TEST FAIL | STOP. Cannot claim done. |

---

## State Tracking

Every response MUST start with:

```text
[O3.PhaseX] [Baseline: SET|UNSET] [Regression: SAFE|DETECTED|UNKNOWN] [Status: in_progress|blocked|complete]
```

---

## Definition of Done (DoD)

A task is ONLY done when:

1. **Tests**: All pass with EXECUTION_BLOCK proof
2. **Regression**: REGRESSION_DELTA shows SAFE
3. **Warnings**: Count same or lower than baseline
4. **Smoke**: Platform-specific verification passed
5. **Confidence**: Can honestly say "I ran this and saw it work"

**If you cannot show proof, say**: "I cannot verify this - manual testing required."

---

## Anti-Sycophancy Oath

```text
I will NOT claim "done" to end a frustrating session.
I will NOT describe tests I didn't actually run.
I will NOT assume my fix works without verification.
I will show PROOF or admit I cannot verify.
User frustration with honest "not done" > false "done".
```

---

## User's Task

$ARGUMENTS
