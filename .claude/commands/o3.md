# /o3 - Anti-Regression Orchestrator v3

**Version 3**: Full workflow with anti-regression guarantees. Combines isolated coder + dual reviewers + regression tracking.

**Core principle**: NEVER claim "done" without EXECUTION PROOF + REGRESSION CHECK.

Uses agents: `coder-v3`, `planner-v3`, `intake-v3`, `fresh-reviewer-v3`

---

## VSCODE COMPATIBILITY (CRITICAL)

**VSCode plugin has a bug with parallel tool calls. To avoid "API Error: 400":**

1. **DO NOT use Task tool with Explore agent** - It makes parallel calls that crash
2. **Explore manually** - Use Read, Grep, Glob directly, ONE AT A TIME
3. **Sequential tool calls only** - Never batch multiple tool calls in one response
4. **Wait for each result** - Before making next tool call

---

## THE FIVE SINS (from real failures)

These are BLOCKING mistakes that v3 prevents:

| Sin | Description | Prevention |
|-----|-------------|------------|
| **SIN 1** | Claiming "done" without testing | EXECUTION_BLOCK required |
| **SIN 2** | No actual play-testing (only unit tests) | SMOKE_TEST required |
| **SIN 3** | Self-fulfilling tests | BASELINE comparison required |
| **SIN 4** | Fix-break cycle | REGRESSION_DELTA required |
| **SIN 5** | Ignoring warnings | WARNING_COUNT required |

---

## MANDATORY PROOF BLOCKS

### BASELINE_BLOCK (captured BEFORE any changes)

```text
┌─────────────────────────────────────────────┐
│ BASELINE_BLOCK                              │
├─────────────────────────────────────────────┤
│ Tests passing: [N]                          │
│ Tests failing: [N]                          │
│ Warnings: [N]                               │
│ Errors: [N]                                 │
│ Git SHA: [hash]                             │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

### EXECUTION_BLOCK (required for ANY completion claim)

```text
┌─────────────────────────────────────────────┐
│ EXECUTION_BLOCK                             │
├─────────────────────────────────────────────┤
│ $ [actual command run]                      │
│ [actual output - last 20+ lines]            │
│ EXIT_CODE: [0 or N]                         │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

### REGRESSION_DELTA (captured AFTER changes)

```text
┌─────────────────────────────────────────────┐
│ REGRESSION_DELTA                            │
├─────────────────────────────────────────────┤
│ Tests: [N] passed (was [M]) [+/-diff]       │
│ Warnings: [N] (was [M]) [+/-diff]           │
│ Errors: [N] (was [M]) [+/-diff]             │
│ VERDICT: [SAFE|REGRESSION]                  │
└─────────────────────────────────────────────┘
```

**If REGRESSION detected, STOP and report before continuing.**

### SMOKE_TEST (platform-specific verification)

```text
┌─────────────────────────────────────────────┐
│ SMOKE_TEST                                  │
├─────────────────────────────────────────────┤
│ Method: [Editor logs | Manual test | etc]   │
│ Warnings before: [N]                        │
│ Warnings after: [N]                         │
│ New errors: [list or "none"]                │
│ VERDICT: [PASS|FAIL]                        │
└─────────────────────────────────────────────┘
```

---

## FORBIDDEN PHRASES

NEVER output these without preceding PROOF BLOCKS:

- "Done" / "Fixed" / "Complete" / "Finished"
- "Tests pass" / "Should work" / "This fixes it"
- "I verified" / "I tested" / "I confirmed"
- "The issue is resolved"

**Replace with**: "Running verification now..." [then show actual output]

---

## State Tracking

Every response MUST start with:

```text
[O3.PhaseX] [Baseline: SET|UNSET] [Regression: SAFE|DETECTED|UNKNOWN] [Status: in_progress|blocked|complete]
```

---

## Phase Flow (10 Phases, 3 Gates)

### Phase 1: BASELINE_CAPTURE

**Before touching ANY code:**

1. Run existing tests, capture output
2. Count current warnings/errors
3. Record git SHA
4. Output BASELINE_BLOCK

```bash
# Capture baseline
npm test 2>&1 | tee /tmp/baseline.txt || true
echo "TESTS: $(grep -c 'passing\|✓' /tmp/baseline.txt || echo 0)"
echo "WARNINGS: $(grep -ci 'warn' /tmp/baseline.txt || echo 0)"
echo "GIT_SHA: $(git rev-parse HEAD)"
```

**Do NOT proceed without BASELINE_BLOCK.**

### Phase 2: INTAKE

Enter plan mode, ask clarifying questions.

1. Call `EnterPlanMode` tool
2. Ask clarifying questions using `AskUserQuestion`
3. Cover: issue, expected behavior, reproduction steps
4. Write spec to `.claude/temp/spec.md` (include BASELINE_BLOCK)
5. VERIFY: Show `cat .claude/temp/spec.md | head -30` output

### Phase 3: PLANNING

Design architecture (still in plan mode).

1. Design architecture based on spec
2. Write to `.claude/temp/architecture.md`:
   - Component design
   - File structure
   - Dependencies
   - TDD test plan
   - **Regression checkpoints**
   - **Smoke test plan**
3. VERIFY: Show `cat .claude/temp/architecture.md | head -30` output

### Phase 4: PLAN_DUAL_REVIEW (GATE 1)

Both reviewers must approve the plan.

**IMPORTANT: Exit plan mode FIRST to allow `claude -p` subprocess.**

1. Call `ExitPlanMode` tool (temporary - to run reviewers)

#### Reviewer 1: Gemini

Call `mcp__gemini__ask-gemini` with spec + architecture content:

```text
VERDICT: [APPROVED|NEEDS_WORK]
REGRESSION_STRATEGY: [adequate|missing]
ISSUES: [list]
SUGGESTIONS: [list]
```

#### Reviewer 2: Isolated Claude

```bash
claude -p "You are a software architect with ZERO context.
Read .claude/temp/spec.md and .claude/temp/architecture.md
Review for: requirements completeness, architecture feasibility, TDD strategy, REGRESSION STRATEGY.
Output to .claude/temp/plan-review.md with VERDICT, ISSUES, SUGGESTIONS." \
  --allowedTools Read,Glob,Grep,Write \
  --model opus \
  --print
```

#### If NEEDS_WORK (max 3 iterations):

1. Call `EnterPlanMode` tool
2. Fix issues in spec/architecture
3. Call `ExitPlanMode` tool
4. Re-run both reviewers

VERIFY: Both verdicts APPROVED before proceeding.

### Phase 5: USER_GATE_PLAN

Present plan for user approval.

**MUST PRESENT** (not just "should I proceed?"):

1. **Artifact paths**: Show full paths to spec.md and architecture.md
2. **Spec summary**: Key requirements (3-5 bullet points)
3. **Architecture summary**: Components, files to create/modify
4. **TDD plan**: What tests will be written
5. **Regression strategy**: How we'll prevent regressions
6. **Both review verdicts**: Gemini + Isolated Claude

Output format:

```text
┌─────────────────────────────────────────────┐
│ PLAN SUMMARY                                │
├─────────────────────────────────────────────┤
│ Spec: .claude/temp/spec.md                  │
│ Architecture: .claude/temp/architecture.md  │
│ Plan Review: .claude/temp/plan-review.md    │
├─────────────────────────────────────────────┤
│ BASELINE:                                   │
│ • Tests: [N] passing                        │
│ • Warnings: [N]                             │
│ • Git SHA: [hash]                           │
├─────────────────────────────────────────────┤
│ REQUIREMENTS:                               │
│ • [requirement 1]                           │
│ • [requirement 2]                           │
├─────────────────────────────────────────────┤
│ FILES TO CREATE/MODIFY:                     │
│ • [file1] - [purpose]                       │
├─────────────────────────────────────────────┤
│ TDD PLAN:                                   │
│ • [test 1]                                  │
├─────────────────────────────────────────────┤
│ GEMINI VERDICT: [APPROVED|NEEDS_WORK]       │
│ CLAUDE VERDICT: [APPROVED|NEEDS_WORK]       │
└─────────────────────────────────────────────┘
```

Output: `--- WAITING FOR PLAN APPROVAL ---`

Wait for user approval.

---

### Phase 6: TDD_RED - ISOLATED CODER

Spawn isolated coder to write failing tests.

```bash
claude -p "You are a TDD test writer with ZERO prior context.
Read ONLY: .claude/temp/spec.md and .claude/temp/architecture.md
Write tests that MUST FAIL (no implementation exists).
LOOP until tests fail, then output EXECUTION_BLOCK and exit." \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

VERIFY: Coder output shows EXECUTION_BLOCK with EXIT_CODE≠0 (tests failing).

### Phase 7: TEST_DUAL_REVIEW (GATE 2)

Both reviewers validate tests BEFORE implementation.

#### Reviewer 1: Gemini

Validate tests cover spec, are meaningful, and FAIL correctly (RED phase).

```text
VERDICT: [APPROVED|NEEDS_WORK]
COVERAGE_CHECK: [YES|NO - list missing]
RED_PHASE_CHECK: [YES|NO]
ISSUES: [list]
```

#### Reviewer 2: Isolated Claude

```bash
claude -p "You are a test quality reviewer with ZERO context.
Read .claude/temp/spec.md and test files.
Validate tests are well-designed, cover spec, and SHOULD BE FAILING (RED phase).
Output to .claude/temp/test-review.md with VERDICT, RED_PHASE_VALID, COVERAGE, ISSUES." \
  --allowedTools Read,Glob,Grep,Write,Bash \
  --print
```

VERIFY: Both APPROVED + RED_PHASE valid.

---

### Phase 8: TDD_GREEN - ISOLATED CODER

Spawn isolated coder to implement.

```bash
claude -p "You are a TDD implementer with ZERO prior context.
Read: .claude/temp/spec.md, .claude/temp/architecture.md, tests/, /tmp/baseline.txt
CRITICAL: Test files are READ-ONLY. Only edit src/ files.
CRITICAL: After EVERY change, run REGRESSION_DELTA check against baseline.
LOOP (max 5): Fix one error at a time until tests pass.
Output EXECUTION_BLOCK + REGRESSION_DELTA when done." \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

VERIFY: Coder output shows:
- EXECUTION_BLOCK with EXIT_CODE=0
- REGRESSION_DELTA with VERDICT=SAFE

**SECURITY**: If coder edits test files, reject and re-spawn.

---

### Phase 9: CODE_DUAL_REVIEW + SMOKE (GATE 3)

Both reviewers validate implementation + run smoke test.

#### Reviewer 1: Gemini

```text
VERDICT: [APPROVED|NEEDS_WORK]
EXECUTION_CHECK: Did tests pass with EXIT_CODE=0? [YES|NO]
REGRESSION_CHECK: Did warnings increase? [YES|NO]
CODE_QUALITY: [assessment]
SECURITY_ISSUES: [any vulnerabilities]
ISSUES: [list]
```

#### Reviewer 2: Isolated Claude

```bash
claude -p "You are a code reviewer with ZERO context.
Read src/ and tests/. Find problems.
Run: npm test 2>&1 | tee /tmp/final.txt; echo EXIT_CODE: \$?
Compare warnings to baseline: grep -ci warn /tmp/final.txt vs /tmp/baseline.txt
Output to .claude/temp/code-review.md with:
- VERDICT
- EXIT_CODE
- REGRESSION_DELTA (compare to baseline)
- SMOKE_TEST result
- CRITICAL_ISSUES, WARNINGS, SUGGESTIONS" \
  --allowedTools Read,Glob,Grep,Write,Bash \
  --print
```

#### SMOKE_TEST

Run platform-specific smoke test:

```bash
# For npm projects
npm test 2>&1 | tee /tmp/smoke.txt
echo "Warnings: $(grep -ci warn /tmp/smoke.txt || echo 0)"

# For Unity - check Editor logs
# For web - check browser console
```

Output SMOKE_TEST block.

VERIFY: Both APPROVED + REGRESSION_DELTA=SAFE + SMOKE_TEST=PASS.

---

### Phase 10: COMPLETION

Only output completion if ALL conditions met:

- [ ] BASELINE_BLOCK captured at start
- [ ] EXECUTION_BLOCK shows EXIT_CODE=0
- [ ] REGRESSION_DELTA shows SAFE (no new failures, warnings not increased)
- [ ] SMOKE_TEST shows PASS
- [ ] Both reviewers APPROVED at all 3 gates

```text
┌─────────────────────────────────────────────┐
│ COMPLETION CHECKLIST                        │
├─────────────────────────────────────────────┤
│ [x] Baseline captured                       │
│ [x] Tests pass (EXECUTION_BLOCK shown)      │
│ [x] No regression (REGRESSION_DELTA=SAFE)   │
│ [x] Warnings stable (before/after same)     │
│ [x] Smoke test pass (SMOKE_TEST shown)      │
│ [x] All reviews passed (3 gates)            │
│ VERDICT: COMPLETE                           │
└─────────────────────────────────────────────┘
```

Output: `✓ ORCHESTRATION COMPLETE`

---

## Circuit Breakers

| Trigger | Action |
|---------|--------|
| No BASELINE_BLOCK | STOP. Capture baseline first |
| Claim without EXECUTION_BLOCK | RETRACT. Run verification |
| REGRESSION_DELTA = REGRESSION | STOP. Fix regression first |
| Warnings increased | STOP. Fix warnings first |
| Same error 2x | STOP. Escalate to user |
| Tests fail 5x | STOP. "MANUAL INTERVENTION REQUIRED" |
| Review fails 3x (any gate) | STOP. "REVIEW LOOP EXCEEDED" |
| SMOKE_TEST FAIL | STOP. Cannot claim done |

Output format:

```text
⚠️ CIRCUIT BREAKER ACTIVATED
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Trigger: [which]
Attempts: [N/max]
Last error: [paste]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Options:
  a) git reset --hard [baseline SHA]
  b) User provides context
  c) Different approach

Awaiting user decision...
```

---

## Anti-Sycophancy Oath

```text
I will NOT claim "done" to end a frustrating session.
I will NOT describe tests I didn't actually run.
I will NOT assume my fix works without verification.
I will NOT ignore warnings or regressions.
I will show PROOF or admit I cannot verify.
User frustration with honest "not done" > false "done".
```

---

## 3-Gate Summary

| Gate | Phase | What's Reviewed | Reviewers |
|------|-------|-----------------|-----------|
| GATE 1 | Phase 4 | Plan (spec + architecture + regression strategy) | Gemini + Isolated Claude |
| GATE 2 | Phase 7 | Tests (before implementation, must FAIL) | Gemini + Isolated Claude |
| GATE 3 | Phase 9 | Code + REGRESSION_DELTA + SMOKE_TEST | Gemini + Isolated Claude |

---

## User's Task

$ARGUMENTS
