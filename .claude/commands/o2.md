# /o2 - Orchestrated Development Workflow v2

**Version 2**: 10-phase workflow with 3-gate dual-review + isolated coder architecture.

**Note**: Uses inline prompts via `claude -p`, not separate agent files.

Key differences from v1 (`/o1`):
- 3 review gates (Plan, Tests, Code) with dual reviewers each
- Coder spawned via `claude -p` for context isolation
- Orchestrator never writes code directly

---

## VSCODE COMPATIBILITY (CRITICAL)

**VSCode plugin has a bug with parallel tool calls. To avoid "API Error: 400":**

1. **DO NOT use Task tool with Explore agent** - It makes parallel calls that crash
2. **Explore manually** - Use Read, Grep, Glob directly, ONE AT A TIME
3. **Sequential tool calls only** - Never batch multiple tool calls in one response during exploration
4. **Wait for each result** - Before making next tool call

This applies to ALL phases, especially INTAKE when understanding the codebase.

---

## Instructions

You are now in **Orchestration Mode**. Follow this workflow exactly.

---

## State Tracking

Every response MUST start with:

```text
[Orc.PhaseX_NAME] [Gemini: Y/3] [Claude: Y/3] [Exec: PROVEN|UNPROVEN] [Exit: 0|N|PENDING] [Status: in_progress|blocked|complete]
```

Rules:

- `Exec: PROVEN` = EXECUTION_BLOCK present in this message
- `Exec: UNPROVEN` = blocks Status: complete
- `Exit: N` (non-zero) = blocks Status: complete
- `Status: blocked` = circuit breaker triggered

---

## EXECUTION_BLOCK Requirement

Before ANY completion claim, provide:

```text
┌─────────────────────────────────────────────┐
│ EXECUTION_BLOCK                             │
├─────────────────────────────────────────────┤
│ $ [command]                                 │
│ [output - last 10+ lines]                   │
│ EXIT_CODE: [0 or N]                         │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

**Forbidden without EXECUTION_BLOCK showing EXIT_CODE=0:**

- "Done" / "Fixed" / "Complete" / "Tests pass" / "It works"

---

## Phase Flow (10 Phases, 3 Gates)

### Phase 1: INTAKE

Enter plan mode, ask clarifying questions.

1. Call `EnterPlanMode` tool
2. Ask clarifying questions using `AskUserQuestion`
3. Cover: inputs, outputs, edge cases, constraints, success criteria
4. Write spec to `.claude/temp/spec.md`
5. VERIFY: Show `cat .claude/temp/spec.md | head -20` output

### Phase 2: PLANNING

Design architecture (still in plan mode).

1. Design architecture based on spec
2. Write to `.claude/temp/architecture.md`:
   - Component design
   - File structure
   - Dependencies
   - TDD test plan
3. VERIFY: Show `cat .claude/temp/architecture.md | head -20` output

### Phase 3: PLAN_DUAL_REVIEW (GATE 1)

Both reviewers must approve the plan.

**IMPORTANT: Exit plan mode FIRST to allow `claude -p` subprocess.**

1. Call `ExitPlanMode` tool (temporary - to run reviewers)

#### Reviewer 1: Gemini

Call `mcp__gemini__ask-gemini` with spec + architecture content:

```text
VERDICT: [APPROVED|NEEDS_WORK]
ISSUES: [list]
SUGGESTIONS: [list]
```

#### Reviewer 2: Isolated Claude (Opus)

```bash
claude -p "You are a software architect with ZERO context.
Read .claude/temp/spec.md and .claude/temp/architecture.md
Review for: requirements completeness, architecture feasibility, TDD strategy, edge cases, security.
Output to .claude/temp/plan-review.md with VERDICT, ISSUES, SUGGESTIONS." \
  --allowedTools Read,Glob,Grep,Write \
  --model opus \
  --print
```

#### If NEEDS_WORK (max 3 iterations):

1. Call `EnterPlanMode` tool
2. Fix issues in spec/architecture
3. Call `ExitPlanMode` tool
4. Re-run both reviewers

VERIFY: Both verdicts APPROVED before proceeding.

### Phase 4: USER_GATE_PLAN

Present plan for user approval (already out of plan mode from Phase 3).

**MUST PRESENT** (not just "should I proceed?"):

1. **Artifact paths**: Show full paths to spec.md and architecture.md
2. **Spec summary**: Key requirements (3-5 bullet points)
3. **Architecture summary**: Components, files to create/modify
4. **TDD plan**: What tests will be written
5. **Both review verdicts**: Gemini + Isolated Claude

Output format:

```text
┌─────────────────────────────────────────────┐
│ PLAN SUMMARY                                │
├─────────────────────────────────────────────┤
│ Spec: .claude/temp/spec.md                  │
│ Architecture: .claude/temp/architecture.md  │
│ Plan Review: .claude/temp/plan-review.md    │
├─────────────────────────────────────────────┤
│ REQUIREMENTS:                               │
│ • [requirement 1]                           │
│ • [requirement 2]                           │
│ • ...                                       │
├─────────────────────────────────────────────┤
│ FILES TO CREATE/MODIFY:                     │
│ • [file1] - [purpose]                       │
│ • [file2] - [purpose]                       │
├─────────────────────────────────────────────┤
│ TDD PLAN:                                   │
│ • [test 1]                                  │
│ • [test 2]                                  │
├─────────────────────────────────────────────┤
│ GEMINI VERDICT: [APPROVED|NEEDS_WORK]       │
│ CLAUDE VERDICT: [APPROVED|NEEDS_WORK]       │
└─────────────────────────────────────────────┘
```

6. Output: `--- WAITING FOR PLAN APPROVAL ---`
7. Wait for user approval

---

### Phase 5: TDD_RED - ISOLATED CODER

Spawn isolated coder to write failing tests. Coder receives ONLY spec + architecture.

```bash
claude -p "You are a TDD test writer with ZERO prior context.
Read ONLY: .claude/temp/spec.md and .claude/temp/architecture.md
Write tests that MUST FAIL (no implementation exists).
LOOP until tests fail, then output EXECUTION_BLOCK and exit." \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

VERIFY: Coder output shows EXECUTION_BLOCK with EXIT_CODE≠0 (tests failing).

### Phase 6: TEST_DUAL_REVIEW (GATE 2)

Both reviewers validate tests BEFORE implementation.

#### Reviewer 1: Gemini

Validate tests cover spec, are meaningful, and FAIL correctly (RED phase).

```text
VERDICT: [APPROVED|NEEDS_WORK]
COVERAGE_CHECK: [YES|NO - list missing]
RED_PHASE_CHECK: [YES|NO]
ISSUES: [list]
```

#### Reviewer 2: Isolated Claude

```bash
claude -p "You are a test quality reviewer with ZERO context.
Read .claude/temp/spec.md and test files.
Validate tests are well-designed, cover spec, and SHOULD BE FAILING (RED phase).
Output to .claude/temp/test-review.md with VERDICT, RED_PHASE_VALID, COVERAGE, ISSUES." \
  --allowedTools Read,Glob,Grep,Write,Bash \
  --print
```

VERIFY: Both APPROVED + RED_PHASE valid. If issues, fix and re-review (max 3 iterations).

---

### Phase 7: TDD_GREEN - ISOLATED CODER

Spawn isolated coder to implement. Coder receives ONLY spec + architecture + tests.

```bash
claude -p "You are a TDD implementer with ZERO prior context.
Read: .claude/temp/spec.md, .claude/temp/architecture.md, tests/, /tmp/test_output.txt
CRITICAL: Test files are READ-ONLY. Only edit src/ files.
LOOP (max 5): Fix one error at a time until tests pass.
Output EXECUTION_BLOCK with EXIT_CODE=0 when done." \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

VERIFY: Coder output shows EXECUTION_BLOCK with EXIT_CODE=0 (tests passing).

**SECURITY**: If coder edits test files, reject and re-spawn.

---

### Phase 8: CODE_DUAL_REVIEW (GATE 3)

Both reviewers validate implementation.

#### Reviewer 1: Gemini

```text
VERDICT: [APPROVED|NEEDS_WORK]
EXECUTION_CHECK: Did tests pass with EXIT_CODE=0? [YES|NO]
CODE_QUALITY: [assessment]
SECURITY_ISSUES: [any vulnerabilities]
ISSUES: [list]
```

#### Reviewer 2: Isolated Claude

```bash
claude -p "You are a code reviewer with ZERO context.
Read src/ and tests/. Find problems.
Run: npm test 2>&1; echo EXIT_CODE: \$?
Output to .claude/temp/code-review.md with VERDICT, EXIT_CODE, CRITICAL_ISSUES, WARNINGS, SUGGESTIONS." \
  --allowedTools Read,Glob,Grep,Write,Bash \
  --print
```

VERIFY: Both APPROVED + EXIT_CODE=0. If issues, fix and re-review (max 3 iterations).

---

### Phase 9: USER_GATE_CODE

Code approval.

1. Present:
   - Implementation summary
   - Gemini review (with EXECUTION_CHECK)
   - Isolated Claude review
   - EXECUTION_BLOCK (actual test output)
2. Output: `--- WAITING FOR CODE APPROVAL ---`
3. Wait for user approval

---

### Phase 10: SUMMARY

Complete.

1. Final verification:

```bash
npm test 2>&1 | tail -20
echo "EXIT_CODE: $?"
echo "TIMESTAMP: $(date '+%Y-%m-%d %H:%M:%SS')"
```

2. Generate TLDR with files created/modified
3. ONLY output `✓ ORCHESTRATION COMPLETE` if EXIT_CODE=0

---

## Circuit Breakers

| Trigger | Action |
| ------- | ------ |
| Same error 2x | STOP. Escalation options |
| Tests fail 5x | STOP. "MANUAL INTERVENTION REQUIRED" |
| Review fails 3x (any gate) | STOP. "REVIEW LOOP EXCEEDED" |
| Claim without EXECUTION_BLOCK | RETRACT. Run verification |
| Gemini empty 2x | Proceed with warning |
| Context >80% | Run /compact, restart phase |

Output format:

```text
⚠️ CIRCUIT BREAKER ACTIVATED
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Trigger: [which]
Attempts: [N/max]
Last error: [paste]
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Options:
  a) git reset --hard
  b) User provides context
  c) Different approach

Awaiting user decision...
```

---

## 3-Gate Summary

| Gate | Phase | What's Reviewed | Reviewers |
| ---- | ----- | --------------- | --------- |
| GATE 1 | Phase 3 | Plan (spec + architecture) | Gemini + Isolated Claude Opus |
| GATE 2 | Phase 6 | Tests (before implementation) | Gemini + Isolated Claude |
| GATE 3 | Phase 8 | Code (after implementation) | Gemini + Isolated Claude |

---

## User's Task

$ARGUMENTS
