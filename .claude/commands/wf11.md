# /wf11 - Workflow v11 (Anthropic-Only)

**Version 11**: wf10 but using ONLY Anthropic models. No Gemini/Codex MCP tools.

**Usage:**
- `/wf11 <task>` — Fully autonomous (Anthropic-only)
- `/wf11 -h <task>` — Human gate after tests written

**Key difference from wf10**: All reviews done by fresh Claude subprocess (`claude -p`) instead of Gemini/Codex MCP tools. Same quality, no external dependencies.

---

## Flag Detection

```bash
HUMAN_GATE=false
TASK="$ARGUMENTS"

if [[ "$ARGUMENTS" == *"-h"* ]]; then
  HUMAN_GATE=true
  TASK="${ARGUMENTS//-h/}"
  TASK="${TASK## }"  # trim leading space
fi

echo "HUMAN_GATE: $HUMAN_GATE"
echo "TASK: $TASK"
```

---

## CRITICAL: NO PRE-EXISTING TEST FAILURES

**The baseline has 100% passing tests. ALWAYS.**

If tests fail, YOU broke them. Not "pre-existing." Fix the implementation.

---

## MANDATORY PROOF BLOCKS

### BASELINE_BLOCK (captured BEFORE any changes)

```text
┌─────────────────────────────────────────────┐
│ BASELINE_BLOCK                              │
├─────────────────────────────────────────────┤
│ Tests passing: [N]                          │
│ Tests failing: [N]                          │
│ Git SHA: [hash]                             │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

### EXECUTION_BLOCK (required for ANY completion claim)

```text
┌─────────────────────────────────────────────┐
│ EXECUTION_BLOCK                             │
├─────────────────────────────────────────────┤
│ $ [actual command run]                      │
│ [actual output - last 20+ lines]            │
│ EXIT_CODE: [0 or N]                         │
│ TIMESTAMP: [YYYY-MM-DD HH:MM:SS]            │
└─────────────────────────────────────────────┘
```

---

## Phase Flow (8 Phases, 2 Gates, 0-1 Human Gates)

**If `-h` flag**: Human gate after Phase 5 (TDD_RED)

### Phase 1: BASELINE_CAPTURE

Before touching ANY code:

1. Run existing tests, capture output
2. Record git SHA
3. Output BASELINE_BLOCK

```bash
npm test 2>&1 | tee /tmp/baseline.txt || true
echo "GIT_SHA: $(git rev-parse HEAD)"
```

**Do NOT proceed without BASELINE_BLOCK.**

---

### Phase 2: INTAKE (Autonomous)

Infer requirements from codebase and user task. NO questions asked.

1. Read the user's task/request
2. Explore relevant codebase files
3. Write spec to `.claude/temp/spec.md`
4. VERIFY: Show `cat .claude/temp/spec.md | head -30`

---

### Phase 3: PLANNING (Dual Claude Brainstorm)

**Instead of Gemini brainstorm, spawn two Claude reviewers in parallel:**

```bash
# Reviewer A: Architecture focus
claude -p "You are an architecture reviewer.
Task: $(cat .claude/temp/spec.md | head -20)

Propose 3 design approaches with pros/cons.
Focus on: maintainability, testability, performance.
Output structured comparison." \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/arch-review-a.txt &

# Reviewer B: Implementation focus
claude -p "You are an implementation reviewer.
Task: $(cat .claude/temp/spec.md | head -20)

Propose 3 implementation strategies.
Focus on: TDD plan, risk zones, dependencies.
Output structured comparison." \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/arch-review-b.txt &

wait
```

**Merge insights into `.claude/temp/architecture.md`:**
- Design Exploration (alternatives considered)
- Component design (recommended)
- File structure
- TDD test plan
- High-risk zones

---

### Phase 4: GATE 1/2 - PLAN_REVIEW (Dual Claude PARALLEL)

**Spawn TWO fresh Claude reviewers in parallel:**

```bash
# Staff Engineer Claude
claude -p "You are a staff engineer reviewer with ZERO prior context.

Read: .claude/temp/spec.md, .claude/temp/architecture.md

Review for:
1. Spec completeness (all edge cases?)
2. Architecture soundness (scalable? testable?)
3. TDD plan coverage (all requirements have tests?)
4. Risk assessment (high-risk zones identified?)

Output:
PLAN_REVIEW (Staff Engineer)
----------------------------
Spec:         [OK|ISSUE: reason]
Architecture: [OK|ISSUE: reason]
TDD Plan:     [OK|ISSUE: reason]
Risks:        [OK|ISSUE: reason]
----------------------------
VERDICT: [APPROVED|NEEDS_WORK]
ISSUES: [list or none]" \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/plan-review-1.txt &

# Code Reviewer Claude
claude -p "You are a code reviewer with ZERO prior context.

Read: .claude/temp/spec.md, .claude/temp/architecture.md

Review for:
1. Existing patterns (does this match codebase style?)
2. Dependencies (any new deps needed?)
3. Breaking changes (any backwards compatibility issues?)
4. Security (OWASP top 10 considerations?)

Output:
PLAN_REVIEW (Code Reviewer)
---------------------------
Patterns:     [OK|ISSUE: reason]
Dependencies: [OK|ISSUE: reason]
Breaking:     [OK|ISSUE: reason]
Security:     [OK|ISSUE: reason]
---------------------------
VERDICT: [APPROVED|NEEDS_WORK]
ISSUES: [list or none]" \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/plan-review-2.txt &

wait
cat /tmp/plan-review-1.txt /tmp/plan-review-2.txt
```

**If NEEDS_WORK**: Fix and re-review (max 3).

---

### Phase 5: TDD_RED — ISOLATED CODER

Spawn isolated coder to write failing tests:

```bash
claude -p "You are a TDD test writer with ZERO prior context.

Read: .claude/temp/spec.md, .claude/temp/architecture.md

Write RED tests:
- At least 1 test per requirement
- Extra tests for high-risk zones
- Tests MUST FAIL

After writing, run tests to verify they fail.
Output EXECUTION_BLOCK showing EXIT_CODE≠0." \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

**Auto-stage tests:**
```bash
git add tests/
echo "✓ Tests staged after TDD_RED"
```

---

### HUMAN GATE (Only if `-h` flag)

**If HUMAN_GATE=true, STOP here and display:**

## [Architecture](.claude/temp/architecture.md)

[Read architecture.md and write a comprehensive 3-5 sentence summary of the design: what components are being built, how they interact, key technical decisions made, and the overall approach.]

| Test | Description |
|------|-------------|
| `[testName1]` | [What this test validates - one clear sentence] |
| `[testName2]` | [What this test validates - one clear sentence] |
| `[testName3]` | [What this test validates - one clear sentence] |

Tests staged. Awaiting approval...

**Wait for user approval before proceeding to Phase 6.**

---

### Phase 6: TDD_GREEN — ISOLATED CODER

Spawn isolated coder to implement:

```bash
claude -p "You are a TDD implementer with ZERO prior context.

Read: .claude/temp/spec.md, .claude/temp/architecture.md, test files

CRITICAL: Test files are READ-ONLY. Only edit src/ files.

Fix one error at a time until tests pass.

Output:
1. EXECUTION_BLOCK showing EXIT_CODE=0
2. REGRESSION_DELTA comparing to baseline" \
  --allowedTools Read,Write,Edit,Bash,Glob,Grep \
  --print
```

**VERIFY**: EXIT_CODE=0 and REGRESSION_DELTA=SAFE

---

### Phase 7: GATE 2/2 - CODE_REVIEW (Triple Claude PARALLEL)

**Three fresh Claude reviewers in parallel:**

```bash
# Reviewer 1: Spec Match
claude -p "You are a spec compliance reviewer with ZERO prior context.

Read:
- .claude/temp/spec.md (requirements)
- src/ files (implementation)
- tests/ files

Check: Does the implementation satisfy ALL requirements in spec?

Output:
CODE_REVIEW (Spec Match)
------------------------
[For each requirement: MET|UNMET with evidence]
------------------------
VERDICT: [APPROVED|NEEDS_WORK]" \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/code-review-1.txt &

# Reviewer 2: Code Quality
claude -p "You are a code quality reviewer with ZERO prior context.

Read:
- .claude/temp/architecture.md
- src/ files (implementation)
- tests/ files

Check:
1. Code style consistency
2. No code smells (long functions, deep nesting, etc.)
3. Proper error handling
4. Test quality and coverage

Output:
CODE_REVIEW (Quality)
---------------------
Style:      [OK|ISSUE: reason]
Smells:     [OK|ISSUE: reason]
Errors:     [OK|ISSUE: reason]
Tests:      [OK|ISSUE: reason]
---------------------
VERDICT: [APPROVED|NEEDS_WORK]" \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/code-review-2.txt &

# Reviewer 3: Security
claude -p "You are a security reviewer with ZERO prior context.

Read: src/ files, tests/ files

Check OWASP Top 10:
- Injection vulnerabilities
- Broken authentication
- Sensitive data exposure
- XSS potential
- Insecure dependencies

Output:
CODE_REVIEW (Security)
----------------------
[Security findings or 'No issues found']
----------------------
VERDICT: [APPROVED|NEEDS_WORK]" \
  --allowedTools Read,Glob,Grep \
  --print > /tmp/code-review-3.txt &

wait
cat /tmp/code-review-1.txt /tmp/code-review-2.txt /tmp/code-review-3.txt
```

#### SMOKE_TEST + Gate Checkpoint

```bash
npm test 2>&1 | tee /tmp/smoke.txt
echo "EXIT_CODE: $?"
```

All must pass: 3 Claude reviewers APPROVED + SMOKE_TEST PASS

---

### Phase 8: COMPLETION + AUTO_COMMIT

Only proceed if ALL pass:
- BASELINE_BLOCK captured
- EXIT_CODE=0
- REGRESSION_DELTA=SAFE
- All reviews passed

```bash
git add -A
TASK_SUMMARY=$(head -5 .claude/temp/spec.md | grep -v "^#" | head -1)

git commit -m "$(cat <<EOF
feat: ${TASK_SUMMARY}

- Planning: dual Claude brainstorm
- Reviews: 5 Claude reviewers (2 plan + 3 code)
- Regression: SAFE
- External deps: None (Anthropic-only)

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"

echo "✓ Auto-committed"
git log -1 --oneline
```

Output: `✓ ORCHESTRATION COMPLETE (wf11)`

---

## Circuit Breakers

| Trigger | Action |
|---------|--------|
| No BASELINE_BLOCK | STOP |
| REGRESSION_DELTA = REGRESSION | STOP |
| Tests fail 5x | STOP |
| Review fails 3x | STOP |
| "Pre-existing failures" claim | RETRACT. Fix the code. |

---

## Comparison: wf11 vs wf10

| Aspect | wf10-gc | wf11 |
|--------|---------|------|
| MCP tools | Gemini + Codex | **None** |
| Plan reviewers | 2 (Codex + Gemini) | 2 (Claude + Claude) |
| Code reviewers | 3 (CodeSmell + Codex + Gemini) | 3 (Claude × 3) |
| External deps | Gemini API + Codex API | **None** |
| Human gate | Optional `-h` | Optional `-h` |
| Brainstorm | mcp__gemini__brainstorm | Dual Claude subprocess |

---

## When to Use wf11

- No MCP tools configured
- Want to avoid external API costs
- Offline/air-gapped environments
- Pure Anthropic billing (no OpenAI/Google)
- Testing Claude-vs-Claude review quality

---

## User's Task

$ARGUMENTS
